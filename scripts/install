# This is a an install script which will rebuild all the docker containers and
# fire them all up.
#
# Use install script when:
#     - You want to rebuild the containers from scratch
#     - You have made changes to a Dockerfile and want to see them.


#!/bin/sh

#### OPTION HANDLING ####
ENVS_NOT_USED="rails-webserver"
ENVS="db daoserver webserver"
if [ $# -ne 0 ]
    then
    ENVS="$@"
fi

# Turn off existing
for ENV in $ENVS
do
    sudo docker kill $ENV
    sudo docker rm -v $ENV
done

# Build replacements
for ENV in $ENVS
do
    case $ENV in
        db)
            pushd database
            sudo docker build -t db_image .
            popd
        ;;
        daoserver)
            pushd daoserver
            sudo docker build -t daoserver_image .
            popd
        ;;
        webserver)
            pushd webserver
            sudo docker build -t webserver_image .
            popd
        ;;
        rails-webserver)
            pushd rails_webserver/src/webapp
            sudo docker build -t rails_webapp_image .
            popd
        ;;
        *)
        # unknown option
        ;;
    esac
done


# Turn on replacements
for ENV in $ENVS
do
    case $ENV in
        db)
            rm -f database/env_file
            python -u scripts/make_db_env_file.py
            sudo docker run --env-file=database/env_file -d -P --name db db_image
            rm -f database/env_file
            sleep 10    # wait for db to finish startup
        ;;
        daoserver)
            rm -f daoserver/env_file
            python -u scripts/make_daoserver_env_file.py
            sudo docker run --env-file=daoserver/env_file --name=daoserver -d -p 5001:5000 --link=db daoserver_image
            rm -f daoserver/env_file
        ;;
        webserver)
            rm -f webserver/env_file
            python -u scripts/make_webserver_env_file.py
            sudo docker run --env-file=webserver/env_file --name=webserver -d -p 5000:8000 --link=db --link=daoserver webserver_image
            rm -f webserver/env_file
        sleep 5
        ;;
        rails-webserver)
            sudo docker run --name=rails-webserver -d -p 3000:3000 --link=daoserver rails_webapp_image
        sleep 5
        ;;
        *)
        # unknown option
        ;;
    esac
done

exit
